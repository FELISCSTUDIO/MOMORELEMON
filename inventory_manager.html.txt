<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店內庫存與效期管理系統 - 多頁面</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Noto Sans CJK TC 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 使用 Noto Sans TC 作為主要字體 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* 定義滾動條樣式，讓表格看起來更美觀 */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        /* 頁面切換效果 */
        .page-content {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0.5; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-6 md:p-8">

    <!-- 庫存管理主要容器 -->
    <div class="max-w-6xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 border-b-4 border-indigo-500 pb-2">
                店內庫存管理中心
            </h1>
            <p class="text-gray-600 mt-2">即時追蹤商品數量與效期，確保營運順暢。</p>
            <div id="userStatus" class="mt-2 text-sm text-gray-500">
                <!-- 用戶狀態將顯示於此 -->
            </div>
        </header>

        <!-- 導航列 -->
        <nav class="flex space-x-2 p-2 bg-white rounded-xl shadow-lg mb-8">
            <button onclick="showPage('overview')" id="nav-overview" class="page-nav-button px-6 py-3 rounded-lg font-bold text-white bg-indigo-600 transition duration-150 shadow-md hover:bg-indigo-700">
                1. 庫存總覽
            </button>
            <button onclick="showPage('restock')" id="nav-restock" class="page-nav-button px-6 py-3 rounded-lg font-medium text-gray-700 bg-gray-200 transition duration-150 hover:bg-indigo-100 hover:text-indigo-600">
                2. 進貨頁面
            </button>
            <button onclick="showPage('audit')" id="nav-audit" class="page-nav-button px-6 py-3 rounded-lg font-medium text-gray-700 bg-gray-200 transition duration-150 hover:bg-indigo-100 hover:text-indigo-600">
                3. 盤點
            </button>
        </nav>
        
        <!-- 頁面內容區塊 -->

        <!-- ========================================================================================= -->
        <!-- 1. 庫存總覽頁面 -->
        <!-- ========================================================================================= -->
        <div id="overviewPage" class="page-content block">
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">庫存清單總覽</h2>
                
                <!-- 篩選與排序控制項 -->
                <div class="flex flex-wrap gap-4 mb-4">
                    <select id="sortCriteria" class="p-2 border rounded-lg shadow-sm">
                        <option value="name">依名稱排序 (A-Z)</option>
                        <option value="quantity_asc">依數量排序 (少至多)</option>
                        <option value="quantity_desc">依數量排序 (多至少)</option>
                        <option value="expiry_asc">依效期排序 (最早)</option>
                    </select>
                    <select id="filterCriteria" class="p-2 border rounded-lg shadow-sm">
                        <option value="all">顯示所有</option>
                        <option value="expired">僅顯示已過期</option>
                        <option value="expiring_soon">即將過期 (7天內)</option>
                        <option value="low_stock">低庫存 (數量 ≤ 5)</option>
                    </select>
                </div>

                <!-- 庫存表格 (響應式設計) -->
                <div class="scroll-container overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    商品名稱
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    庫存數量
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    效期 (YYYY-MM-DD)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    狀態
                                </th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">刪除</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="inventoryList" class="bg-white divide-y divide-gray-200">
                            <!-- 庫存資料將由 JavaScript 載入 -->
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- ========================================================================================= -->
        <!-- 2. 進貨頁面 -->
        <!-- ========================================================================================= -->
        <div id="restockPage" class="page-content">
             <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">A. 新增全新商品線 (例如: 新的飲料口味)</h2>
                <form id="addItemForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="itemName" placeholder="商品名稱 (必填)" required
                           class="col-span-1 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="number" id="itemQuantity" placeholder="初始數量 (必填)" required min="0" value="0"
                           class="col-span-1 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="date" id="itemExpiry" title="效期 (必填)" required
                           class="col-span-1 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <button type="submit" id="addButton"
                            class="col-span-1 md:col-span-1 bg-green-600 text-white p-3 rounded-lg font-medium hover:bg-green-700 transition duration-150 shadow-md">
                        <span id="buttonText">新增商品線</span>
                    </button>
                </form>
                <div id="formError" class="text-red-500 mt-2 hidden"></div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">B. 現有商品進貨 (增加庫存數量/更新效期)</h2>
                <form id="restockForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    
                    <div class="col-span-1 md:col-span-1">
                        <label for="restockItemSelect" class="block text-sm font-medium text-gray-700 mb-1">選擇商品</label>
                        <select id="restockItemSelect" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="" disabled selected>-- 請選擇商品 --</option>
                            <!-- 選項將由 JS 載入 -->
                        </select>
                    </div>

                    <div class="col-span-1 md:col-span-1">
                        <label for="restockQuantity" class="block text-sm font-medium text-gray-700 mb-1">本次進貨數量 (增加)</label>
                        <input type="number" id="restockQuantity" placeholder="數量 (必填)" required min="1" value="1"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="col-span-1 md:col-span-1">
                         <label for="restockExpiry" class="block text-sm font-medium text-gray-700 mb-1">新批次效期 (可選填)</label>
                        <input type="date" id="restockExpiry" title="新效期 (可選)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <button type="submit" id="restockButton"
                            class="col-span-1 md:col-span-1 bg-indigo-600 text-white p-3 rounded-lg font-medium hover:bg-indigo-700 transition duration-150 shadow-md">
                        執行進貨
                    </button>
                </form>
                <div id="restockError" class="text-red-500 mt-2 hidden"></div>
            </section>
        </div>

        <!-- ========================================================================================= -->
        <!-- 3. 盤點頁面 -->
        <!-- ========================================================================================= -->
        <div id="auditPage" class="page-content">
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">盤點庫存數量 (輸入實際總量)</h2>
                <div class="scroll-container overflow-x-auto rounded-lg border border-gray-200 shadow-sm mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">
                                    商品名稱
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                    系統庫存
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                    盤點數量 (實際總數)
                                </th>
                            </tr>
                        </thead>
                        <tbody id="auditList" class="bg-white divide-y divide-gray-200">
                            <!-- 盤點清單將由 JavaScript 載入 -->
                            <tr><td colspan="3" class="text-center py-4 text-gray-500">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end">
                    <button onclick="saveAudit()" id="saveAuditButton" disabled
                            class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition duration-150 shadow-lg disabled:bg-indigo-400">
                        儲存盤點結果
                    </button>
                </div>
            </section>
        </div>

        <!-- 浮動錯誤/成功訊息 (Alert Box) -->
        <div id="messageBox" class="fixed bottom-4 right-4 z-50 transition-transform duration-300 transform translate-x-full">
            <div id="messageContent" class="p-4 rounded-lg shadow-xl text-white font-medium flex items-center">
                <!-- 訊息內容 -->
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // 修正：將 setLogLevel 從 firebase-auth 移到 firebase-firestore，以避免 SyntaxError
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 設定 Firebase 變數
        let app;
        let db;
        let auth;
        let inventoryColRef;
        let currentUserId = null;
        let currentInventory = []; // 儲存當前庫存資料
        let currentPage = 'overview'; // 追蹤當前頁面
        
        // 全域變數檢查和初始化
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 庫存低於此數量視為低庫存
        const LOW_STOCK_THRESHOLD = 5;
        // 即將過期天數
        const EXPIRING_SOON_DAYS = 7;
        
        // ==== 輔助函數 ====

        /**
         * 顯示浮動訊息框
         * @param {string} message - 顯示的訊息
         * @param {string} type - 訊息類型 ('success' or 'error')
         */
        function showMessage(message, type) {
            const box = document.getElementById('messageBox');
            const content = document.getElementById('messageContent');
            
            const baseClasses = 'p-4 rounded-lg shadow-xl text-white font-medium flex items-center';
            let specificClasses = '';

            if (type === 'success') {
                specificClasses = 'bg-green-500';
            } else if (type === 'error') {
                specificClasses = 'bg-red-500';
            } else {
                specificClasses = 'bg-blue-500';
            }

            content.className = `${baseClasses} ${specificClasses}`;
            content.innerHTML = `<span>${message}</span>`;
            
            // 顯示訊息
            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            // 3秒後隱藏
            setTimeout(() => {
                box.classList.remove('translate-x-0');
                box.classList.add('translate-x-full');
            }, 3000);
        }

        /**
         * 格式化日期為 YYYY-MM-DD
         * @param {Date} date - 日期物件
         * @returns {string} 格式化後的日期字串
         */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        /**
         * 計算兩個日期之間的天數差
         * @param {string} date1 - 日期字串 (YYYY-MM-DD)
         * @param {string} date2 - 日期字串 (YYYY-MM-DD)
         * @returns {number} 天數差
         */
        function dateDiffInDays(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diffTime = d1.getTime() - d2.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        /**
         * 帶有指數退避的重試機制
         * @param {function} operation - 要執行的異步操作
         * @param {number} maxRetries - 最大重試次數
         * @returns {Promise<any>}
         */
        async function fetchWithRetry(operation, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ==== UI 渲染和邏輯 ====

        /**
         * 根據狀態計算並獲取狀態標籤
         * @param {number} quantity - 庫存數量
         * @param {string} expiryDate - 效期 (YYYY-MM-DD)
         * @returns {object} 包含文本和樣式的物件
         */
        function getItemStatus(quantity, expiryDate) {
            const today = formatDate(new Date());
            const daysLeft = dateDiffInDays(expiryDate, today);

            let text = '良好';
            let classes = 'bg-green-100 text-green-800';

            if (quantity <= LOW_STOCK_THRESHOLD) {
                text = '低庫存';
                classes = 'bg-yellow-100 text-yellow-800';
            }
            if (daysLeft < 0) {
                text = '已過期';
                classes = 'bg-red-100 text-red-800 font-bold';
            } else if (daysLeft <= EXPIRING_SOON_DAYS) {
                text = '即將過期';
                classes = 'bg-orange-100 text-orange-800 font-medium';
            }
            // 已過期優先於低庫存
            if (daysLeft < 0) {
                 text = '已過期';
                 classes = 'bg-red-100 text-red-800 font-bold';
            }

            return { text, classes };
        }
        
        /**
         * 渲染庫存清單到總覽表格中
         * @param {Array<object>} items - 庫存商品陣列
         */
        function renderOverview(items) {
            const listContainer = document.getElementById('inventoryList');
            if (!listContainer) return;
            
            if (items.length === 0) {
                listContainer.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500 italic">目前無庫存商品，請到「進貨頁面」新增。</td></tr>`;
                currentInventory = [];
                return;
            }

            const sortCriteria = document.getElementById('sortCriteria').value;
            const filterCriteria = document.getElementById('filterCriteria').value;
            
            let filteredItems = items.map(item => ({
                ...item,
                status: getItemStatus(item.quantity, item.expiryDate)
            }));

            // 篩選
            if (filterCriteria !== 'all') {
                const today = formatDate(new Date());
                filteredItems = filteredItems.filter(item => {
                    const daysLeft = dateDiffInDays(item.expiryDate, today);
                    if (filterCriteria === 'expired') {
                        return daysLeft < 0;
                    } else if (filterCriteria === 'expiring_soon') {
                        return daysLeft >= 0 && daysLeft <= EXPIRING_SOON_DAYS;
                    } else if (filterCriteria === 'low_stock') {
                        return item.quantity <= LOW_STOCK_THRESHOLD;
                    }
                    return true;
                });
            }

            // 排序 (在客戶端排序，避免 Firestore 索引問題)
            filteredItems.sort((a, b) => {
                switch (sortCriteria) {
                    case 'quantity_asc':
                        return a.quantity - b.quantity;
                    case 'quantity_desc':
                        return b.quantity - a.quantity;
                    case 'expiry_asc':
                        return new Date(a.expiryDate) - new Date(b.expiryDate);
                    case 'name':
                    default:
                        return a.name.localeCompare(b.name, 'zh-Hant');
                }
            });


            const html = filteredItems.map(item => {
                const { text, classes } = item.status;
                
                // 根據效期天數給予提醒
                let expiryDisplay = item.expiryDate;
                if (text === '即將過期') {
                    const daysLeft = dateDiffInDays(item.expiryDate, formatDate(new Date()));
                    expiryDisplay += ` (${daysLeft} 天後)`;
                }

                return `
                    <tr class="hover:bg-gray-50 transition duration-150" data-id="${item.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expiryDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${classes}">
                                ${text}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteItem('${item.id}', '${item.name}')" 
                                class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50 transition">
                                刪除
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            listContainer.innerHTML = html;
        }

        /**
         * 渲染盤點頁面清單
         * @param {Array<object>} items - 庫存商品陣列
         */
        function renderAuditList(items) {
            const auditList = document.getElementById('auditList');
            const saveButton = document.getElementById('saveAuditButton');

            if (items.length === 0) {
                auditList.innerHTML = `<tr><td colspan="3" class="text-center py-6 text-gray-500 italic">無庫存商品可供盤點。</td></tr>`;
                saveButton.disabled = true;
                return;
            }
            saveButton.disabled = false;
            
            const html = items.map(item => `
                <tr class="hover:bg-gray-50 transition duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" data-item-id="${item.id}" value="${item.quantity}" min="0" 
                               class="w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-indigo-500 focus:border-indigo-500 audit-input">
                    </td>
                </tr>
            `).join('');

            auditList.innerHTML = html;
        }
        
        /**
         * 渲染下拉式選單
         * @param {Array<object>} items - 庫存商品陣列
         */
        function renderDropdowns(items) {
            const restockSelect = document.getElementById('restockItemSelect');
            
            // 清空舊選項 (保留第一個預設選項)
            restockSelect.innerHTML = '<option value="" disabled selected>-- 請選擇商品 --</option>';

            items.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (庫存: ${item.quantity})`;
                restockSelect.appendChild(option);
            });
        }

        /**
         * 顯示指定頁面
         * @param {string} pageName - 要顯示的頁面名稱 ('overview', 'restock', 'audit')
         */
        window.showPage = function(pageName) {
            currentPage = pageName;
            
            // 隱藏所有內容區塊
            document.querySelectorAll('.page-content').forEach(div => {
                div.style.display = 'none';
            });

            // 重置導航按鈕樣式
            document.querySelectorAll('.page-nav-button').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'font-bold');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'font-medium');
            });

            // 顯示當前頁面
            const activePage = document.getElementById(`${pageName}Page`);
            const activeButton = document.getElementById(`nav-${pageName}`);
            
            if (activePage) activePage.style.display = 'block';
            if (activeButton) {
                activeButton.classList.remove('bg-gray-200', 'text-gray-700', 'font-medium');
                activeButton.classList.add('bg-indigo-600', 'text-white', 'font-bold');
            }

            // 特殊頁面渲染 (僅在切換到時執行)
            if (pageName === 'audit') {
                // 切換到盤點頁面時，重新渲染盤點清單
                renderAuditList(currentInventory);
            } else if (pageName === 'restock') {
                // 切換到進貨頁面時，重新渲染下拉式選單
                renderDropdowns(currentInventory);
            }
        }
        
        // ==== Firestore 交易操作 ====

        /**
         * 進貨操作：更新現有商品的庫存和/或效期
         * @param {Event} e - 表單提交事件
         */
        async function restockItem(e) {
            e.preventDefault();
            const restockError = document.getElementById('restockError');
            restockError.classList.add('hidden');
            
            const itemId = document.getElementById('restockItemSelect').value;
            const quantityAdded = parseInt(document.getElementById('restockQuantity').value, 10);
            const newExpiryDate = document.getElementById('restockExpiry').value;
            
            if (!itemId || quantityAdded <= 0) {
                restockError.textContent = '請選擇商品並輸入有效的進貨數量。';
                restockError.classList.remove('hidden');
                return;
            }

            try {
                const item = currentInventory.find(i => i.id === itemId);
                if (!item) throw new Error('找不到指定的商品。');

                const itemDocRef = doc(db, inventoryColRef.path, itemId);
                
                const updatedFields = {
                    quantity: item.quantity + quantityAdded,
                    updatedAt: new Date()
                };
                
                if (newExpiryDate) {
                    // 如果輸入了新的效期，則更新它 (假設進貨的批次效期較長)
                    updatedFields.expiryDate = newExpiryDate;
                }

                await fetchWithRetry(() => updateDoc(itemDocRef, updatedFields));
                
                // 清空表單
                document.getElementById('restockForm').reset();
                showMessage(`商品「${item.name}」進貨 ${quantityAdded} 單位，已成功更新！`, 'success');

            } catch (error) {
                console.error("進貨更新失敗:", error);
                restockError.textContent = `進貨失敗：${error.message}`;
                restockError.classList.remove('hidden');
                showMessage('進貨更新失敗，請檢查網路連線。', 'error');
            }
        }
        
        /**
         * 新增全新商品線 (原有的 addItem 功能)
         * @param {Event} e - 表單提交事件
         */
        async function addItem(e) {
            e.preventDefault();
            const formError = document.getElementById('formError');
            formError.classList.add('hidden');
            const addButton = document.getElementById('addButton');
            const buttonText = document.getElementById('buttonText');
            
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value, 10);
            const expiryDate = document.getElementById('itemExpiry').value;

            if (!name || quantity < 0 || !expiryDate) {
                formError.textContent = '請檢查所有欄位是否正確填寫。';
                formError.classList.remove('hidden');
                return;
            }

            try {
                buttonText.textContent = '新增中...';
                addButton.disabled = true;

                // 檢查是否已存在同名商品
                const exists = currentInventory.some(item => item.name === name);
                if (exists) {
                    formError.textContent = '此商品名稱已存在，請使用下方的「現有商品進貨」功能。';
                    formError.classList.remove('hidden');
                    return;
                }

                const newItem = {
                    name,
                    quantity,
                    expiryDate,
                    createdAt: new Date()
                };

                await fetchWithRetry(() => addDoc(inventoryColRef, newItem));
                
                // 清空表單
                document.getElementById('addItemForm').reset();
                document.getElementById('itemQuantity').value = 0; // 重新設定數量為 0
                showMessage(`商品線「${name}」已成功新增！`, 'success');

            } catch (error) {
                console.error("新增商品失敗:", error);
                formError.textContent = `新增失敗：${error.message}`;
                formError.classList.remove('hidden');
                showMessage('新增商品失敗，請檢查網路連線。', 'error');
            } finally {
                buttonText.textContent = '新增商品線';
                addButton.disabled = false;
            }
        }

        /**
         * 盤點操作：批次更新所有商品的庫存數量
         */
        window.saveAudit = async function() {
            const auditInputs = document.querySelectorAll('#auditList .audit-input');
            const saveButton = document.getElementById('saveAuditButton');
            
            if (auditInputs.length === 0) return;
            
            try {
                saveButton.textContent = '儲存中...';
                saveButton.disabled = true;
                const batch = writeBatch(db);
                let changesCount = 0;

                auditInputs.forEach(input => {
                    const id = input.dataset.itemId;
                    const newQuantity = parseInt(input.value, 10);
                    const currentItem = currentInventory.find(i => i.id === id);

                    if (currentItem && newQuantity >= 0 && currentItem.quantity !== newQuantity) {
                        const itemDocRef = doc(db, inventoryColRef.path, id);
                        batch.update(itemDocRef, {
                            quantity: newQuantity,
                            updatedAt: new Date()
                        });
                        changesCount++;
                    }
                });
                
                if (changesCount > 0) {
                    await fetchWithRetry(() => batch.commit());
                    showMessage(`成功更新 ${changesCount} 筆盤點數量！`, 'success');
                } else {
                    showMessage('沒有任何庫存數量變動。', 'success');
                }

            } catch (error) {
                console.error("盤點儲存失敗:", error);
                showMessage('盤點儲存失敗，請檢查網路連線。', 'error');
            } finally {
                saveButton.textContent = '儲存盤點結果';
                saveButton.disabled = false;
            }
        }

        /**
         * 從 Firestore 中刪除商品 (確認機制)
         * @param {string} id - 文件 ID
         * @param {string} name - 商品名稱
         */
        window.deleteItem = function(id, name) {
            // 使用自定義的簡易模態框取代 alert/confirm
            const result = window.prompt(`確定要刪除商品「${name}」嗎？\n請輸入「刪除」來確認：`);
            
            if (result === '刪除') {
                performDelete(id, name);
            } else if (result !== null) {
                showMessage('刪除操作已取消或輸入不正確。', 'error');
            }
        }

        async function performDelete(id, name) {
            try {
                const itemDocRef = doc(db, inventoryColRef.path, id);
                await fetchWithRetry(() => deleteDoc(itemDocRef));
                showMessage(`商品「${name}」已成功刪除！`, 'success');
            } catch (error) {
                console.error("刪除商品失敗:", error);
                showMessage('刪除商品失敗，請檢查網路連線。', 'error');
            }
        }

        // ==== 初始化與即時監聽 ====
        
        /**
         * 初始化 Firebase 應用程式和即時監聽
         */
        async function initializeAppAndAuth() {
            // setLogLevel 應該從 firestore 匯入，但通常在初始化應用後才能使用。
            // 為了除錯，我們把它放在這裡，確保它被呼叫。
            setLogLevel('Debug');
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            inventoryColRef = collection(db, `artifacts/${appId}/public/data/inventory_items`);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                currentUserId = auth.currentUser ? auth.currentUser.uid : 'Anonymous';
                document.getElementById('userStatus').textContent = `App ID: ${appId} | 用戶 ID: ${currentUserId}`;

                startRealtimeListener();

            } catch (error) {
                console.error("Firebase 認證失敗:", error);
                showMessage('應用程式啟動失敗，無法連線至資料庫。', 'error');
                document.getElementById('inventoryList').innerHTML = `<tr><td colspan="5" class="text-center py-6 text-red-600">連線錯誤：請檢查網路或應用程式設定。</td></tr>`;
            }
        }
        
        /**
         * 啟動 Firestore 即時監聽
         */
        function startRealtimeListener() {
            const q = inventoryColRef; 

            onSnapshot(q, (snapshot) => {
                const items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                
                // 更新全域庫存數據
                currentInventory = items; 
                
                // 根據當前頁面重新渲染內容
                if (currentPage === 'overview') {
                    renderOverview(items);
                } else if (currentPage === 'audit') {
                    // 如果在盤點頁面，則更新盤點清單
                    renderAuditList(items);
                } else if (currentPage === 'restock') {
                    // 如果在進貨頁面，則更新下拉選單
                    renderDropdowns(items);
                }
                // 確保總覽頁面總是渲染 (因為它是預設頁面)
                if (document.getElementById('overviewPage').style.display === 'block' || currentPage === 'overview') {
                    renderOverview(items);
                }

            }, (error) => {
                console.error("即時監聽失敗:", error);
                showMessage('資料庫連線中斷，請重新整理。', 'error');
            });
        }
        
        // ==== 事件監聽器 ====
        
        // 頁面載入後，開始初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndAuth();
            
            // 預設顯示庫存總覽頁面
            showPage('overview');
            
            // 綁定「新增全新商品線」表單事件
            document.getElementById('addItemForm').addEventListener('submit', addItem);
            
            // 綁定「現有商品進貨」表單事件
            document.getElementById('restockForm').addEventListener('submit', restockItem);
            
            // 綁定篩選和排序事件 (總覽頁面)
            document.getElementById('sortCriteria').addEventListener('change', () => renderOverview(currentInventory));
            document.getElementById('filterCriteria').addEventListener('change', () => renderOverview(currentInventory));
        });

    </script>
</body>
</html>